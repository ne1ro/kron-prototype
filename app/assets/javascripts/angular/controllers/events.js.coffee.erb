# Events controller
@EventCtrl = ["$scope", "$filter", "User", "Event", "Notification", "socket", ($scope, $filter, User, Event, Notification, socket) ->
  # Get users from path
  path = window.location.pathname
  user_id = path.substr(7)
  
  $scope.events = Event.query uid : user_id, ((data) ->
    # Success
  ), (err) ->
    # Error
  $scope.data = new Date()
  $scope.newEvent = new Event
  $scope.editEvent = new Event
  
  # On message notify
  socket.on 'notify:send', (data) ->
    $scope.notify = data
    $('#black').fadeIn 500
    $('#notify').slideDown 500
    audioElement = document.createElement("audio")
    audioElement.setAttribute "src", "/notification.wav"
    audioElement.setAttribute "autoplay", "autoplay"
    $.get()
    audioElement.addEventListener "load", (->
      audioElement.play()
    ), true

  # Create new event and notifications
  $scope.createEvent = ->
    Event.save uid : user_id, $scope.newEvent, ((data) ->
      # Success callback
      for notification in $scope.newEvent.notifications
        Notification.save uid : user_id, eid : data._id, notification, ((data) ->
          # Notifications success
          socket.emit 'notify:create', data
        ), (err) ->
          # Notifications error
      
      $scope.events.push(data)
      $scope.newEvent = new Event # reset scope`s new event
      $scope.newDate()
      $scope.newEvent.notifications = []
      $scope.addNotification($scope.newEvent.time)
    ), (err) ->
      #error call-back 

  # Show event before edit
  $scope.showEvent = (event, $index) ->
    $scope.editEvent = Event.get id : event._id, uid : user_id, ((data) ->
      # Success
      $scope.editEventIndex = $index
    ), (err) ->
      # Error

  # Update event
  $scope.updateEvent = ->
    $scope.editEvent.$update id : $scope.editEvent._id, uid : user_id, ((data) ->
      # Success
      socket.emit 'notify', $scope.editEvent
      $scope.events[$scope.editEventIndex] = $scope.editEvent
    ), (err) ->
      # Error 
    
  # Destroy event
  $scope.deleteEvent = (event, $index) ->
    Event.delete uid : user_id, id : event._id, ((data) ->
      # Success
      $scope.events.splice($index,1)
    ), (err) ->
      # Error

  # Create new notification
  $scope.addNotification = (datetime) ->
    notification = 
      text : $scope.newEvent.header
      time : $scope.newEvent.time
    $scope.newEvent.notifications.push(notification)

  # Remove notification
  $scope.removeNotification = ($index) ->
    $scope.newEvent.notifications.splice($index,1)

  # Get current data and time
  $scope.newDate = ->
    $scope.newEvent.time = new Date()
    $scope.newEvent.notifications = []
    $scope.addNotification($scope.newEvent.time)
    $scope.month = $scope.newEvent.time.getMonth()
]    
